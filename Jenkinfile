pipeline {
  agent any

  environment {
    REGISTRY = 'aunnutthawat/fastapi-webhook:latest'          // หรือ docker.io/youruser
    APP_NAME = 'pettech'
    COMMIT = "${env.GIT_COMMIT ?: 'dev'}"
    REGISTRY_CREDS = 'dockerhub-credentials' // credentials สำหรับ docker registry
    DEPLOY_HOST = '34.126.120.130'
    DEPLOY_USER = 'nutthawat'
    REMOTE_APP_DIR = '/home/nutthawat/pettech' // โปรเจกต์ path บนเครื่องปลายทาง
    GIT_REPO = 'https://github.com/KKP240/Devtools-Proj-Repo.git'
  }

  options {
    timestamps()
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build & Push Images') {
      steps {
        sh '''
          set -e
          docker build -t ${REGISTRY}/${APP_NAME}-users:${COMMIT} services/users/.
          docker build -t ${REGISTRY}/${APP_NAME}-jobs:${COMMIT} services/jobs/.
          docker build -t ${REGISTRY}/${APP_NAME}-bookings:${COMMIT} services/bookings/.
          docker build -t ${REGISTRY}/${APP_NAME}-web:${COMMIT} web/.
        '''

        withCredentials([usernamePassword(credentialsId: "${REGISTRY_CREDS}", passwordVariable: 'REG_PASS', usernameVariable: 'REG_USER')]) {
          sh '''
            echo "${REG_PASS}" | docker login ${REGISTRY} -u "${REG_USER}" --password-stdin
            docker push ${REGISTRY}/${APP_NAME}-users:${COMMIT}
            docker push ${REGISTRY}/${APP_NAME}-jobs:${COMMIT}
            docker push ${REGISTRY}/${APP_NAME}-bookings:${COMMIT}
            docker push ${REGISTRY}/${APP_NAME}-web:${COMMIT}
            docker logout ${REGISTRY}
          '''
        }
      }
    }

    stage('Deploy (Pull from GitHub)') {
      steps {
        sshagent(credentials: ['ssh-prod_instance']) {
          sh '''
            ssh -o StrictHostKeyChecking=no ${DEPLOY_USER}@${DEPLOY_HOST} "
              set -e
              if [ ! -d '${REMOTE_APP_DIR}' ]; then
                git clone ${GIT_REPO} ${REMOTE_APP_DIR}
              fi
              cd ${REMOTE_APP_DIR}
              git fetch origin
              git reset --hard origin/main   # หรือสาขาที่ต้องการ เช่น 'main' หรือ 'production'
              export REGISTRY=${REGISTRY}
              export APP_NAME=${APP_NAME}
              export COMMIT=${COMMIT}
              docker compose pull users jobs bookings web || true
              docker compose up -d --no-deps users jobs bookings web gateway
            "
          '''
        }
      }
    }
  }

  post {
    always {
      echo 'Pipeline finished.'
    }
  }
}
